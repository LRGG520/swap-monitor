import{a as l}from"./chunk-6TL4NYRY.mjs";import{a as o,b as c}from"./chunk-U6Z4FNB7.mjs";import{a as h,i as d}from"./chunk-E32QME53.mjs";import{g as u}from"./chunk-AADPBGL3.mjs";import g from"eventemitter3";var m="fulfilled",f=(e=>(e.TransactionSent="transactionSent",e.TransactionSendFailed="transactionSendFailed",e.TransactionExecuted="transactionExecuted",e.TransactionExecutionFailed="transactionExecutionFailed",e.ExecutionFinish="executionFinish",e))(f||{}),p=class extends g{constructor(t,n,a=30,e=100,i=10){super();this.taskQueue=new o;this.transactionsQueue=new o;this.outstandingTransactions=new o;this.sentTransactions=[];this.executedTransactions=[];this.endlessConfig=t,this.account=n,this.started=!1,this.accountSequnceNumber=new l(t,n,a,e,i)}async submitNextTransaction(){try{for(;;){let t=await this.accountSequnceNumber.nextSequenceNumber();if(t===null)return;let n=await this.generateNextTransaction(this.account,t);if(!n)return;let a=d({endlessConfig:this.endlessConfig,transaction:n,signer:this.account});await this.outstandingTransactions.enqueue([a,t])}}catch(t){if(t instanceof c)return;throw new Error(`Submit transaction failed for ${this.account.accountAddress.toString()} with error ${t}`)}}async processTransactions(){try{for(;;){let t=[],n=[],[a,e]=await this.outstandingTransactions.dequeue();for(t.push(a),n.push(e);!this.outstandingTransactions.isEmpty();)[a,e]=await this.outstandingTransactions.dequeue(),t.push(a),n.push(e);let i=await Promise.allSettled(t);for(let s=0;s<i.length&&s<n.length;s+=1){let r=i[s];e=n[s],r.status===m?(this.sentTransactions.push([r.value.hash,e,null]),this.emit("transactionSent",{message:`transaction hash ${r.value.hash} has been committed to chain`,transactionHash:r.value.hash}),await this.checkTransaction(r,e)):(this.sentTransactions.push([r.status,e,r.reason]),this.emit("transactionSendFailed",{message:`failed to commit transaction ${this.sentTransactions.length} with error ${r.reason}`,error:r.reason}))}this.emit("executionFinish",{message:`execute ${i.length} transactions finished`})}}catch(t){if(t instanceof c)return;throw new Error(`Process execution failed for ${this.account.accountAddress.toString()} with error ${t}`)}}async checkTransaction(t,n){try{let a=[];a.push(u({endlessConfig:this.endlessConfig,transactionHash:t.value.hash}));let e=await Promise.allSettled(a);for(let i=0;i<e.length;i+=1){let s=e[i];s.status===m?(this.executedTransactions.push([s.value.hash,n,null]),this.emit("transactionExecuted",{message:`transaction hash ${s.value.hash} has been executed on chain`,transactionHash:t.value.hash})):(this.executedTransactions.push([s.status,n,s.reason]),this.emit("transactionExecutionFailed",{message:`failed to execute transaction ${this.executedTransactions.length} with error ${s.reason}`,error:s.reason}))}}catch(a){throw new Error(`Check transaction failed for ${this.account.accountAddress.toString()} with error ${a}`)}}async push(t,n){this.transactionsQueue.enqueue([t,n])}async generateNextTransaction(t,n){if(this.transactionsQueue.isEmpty())return;let[a,e]=await this.transactionsQueue.dequeue();return h({endlessConfig:this.endlessConfig,sender:t.accountAddress,data:a,options:{...e,accountSequenceNumber:n}})}async run(){try{for(;!this.taskQueue.isCancelled();)await(await this.taskQueue.dequeue())()}catch(t){throw new Error(`Unable to start transaction batching: ${t}`)}}start(){if(this.started)throw new Error("worker has already started");this.started=!0,this.taskQueue.enqueue(()=>this.submitNextTransaction()),this.taskQueue.enqueue(()=>this.processTransactions()),this.run()}stop(){if(this.taskQueue.isCancelled())throw new Error("worker has already stopped");this.started=!1,this.taskQueue.cancel()}};export{m as a,f as b,p as c};
//# sourceMappingURL=chunk-6PIN65QY.mjs.map